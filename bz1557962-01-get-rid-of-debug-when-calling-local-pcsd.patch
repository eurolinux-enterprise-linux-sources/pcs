From 62abd88cac78758c1ddcd798b74671cfc47423e3 Mon Sep 17 00:00:00 2001
From: Tomas Jelinek <tojeline@redhat.com>
Date: Tue, 20 Mar 2018 15:39:40 +0100
Subject: [PATCH] get rid of --debug when calling local pcsd

---
 pcsd/pcsd.rb | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/pcsd/pcsd.rb b/pcsd/pcsd.rb
index dcfd5a05..b6bb7a0b 100644
--- a/pcsd/pcsd.rb
+++ b/pcsd/pcsd.rb
@@ -232,8 +232,13 @@ post '/run_pcs' do
     }
     return JSON.pretty_generate(result)
   end
-  # do not reveal potentialy sensitive information
-  command_decoded.delete('--debug')
+  # Do not reveal potentially sensitive information: remove --debug and all its
+  # prefixes since getopt parser in pcs considers them equal to --debug.
+  debug_items = ["--de", "--deb", "--debu", "--debug"]
+  command_sanitized = []
+  command_decoded.each { |item|
+    command_sanitized << item unless debug_items.include?(item)
+  }
 
   allowed_commands = {
     ['cluster', 'auth', '...'] => {
@@ -334,9 +339,9 @@ post '/run_pcs' do
   allowed = false
   command_settings = {}
   allowed_commands.each { |cmd, cmd_settings|
-    if command_decoded == cmd \
+    if command_sanitized == cmd \
       or \
-      (cmd[-1] == '...' and cmd[0..-2] == command_decoded[0..(cmd.length - 2)])
+      (cmd[-1] == '...' and cmd[0..-2] == command_sanitized[0..(cmd.length - 2)])
       then
         allowed = true
         command_settings = cmd_settings
@@ -365,7 +370,7 @@ post '/run_pcs' do
   options = {}
   options['stdin'] = std_in if std_in
   std_out, std_err, retval = run_cmd_options(
-    @auth_user, options, PCS, *command_decoded
+    @auth_user, options, PCS, *command_sanitized
   )
   result = {
     'status' => 'ok',
-- 
2.13.6

